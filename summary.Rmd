---
title: "summary"
output: 
   html_document:
    toc: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      cache = F, 
                      fig.width=8.5, fig.align = 'center', fig.path='Figs/',
                      warning=FALSE, message=FALSE)
```

# Data
```{r rules-data}
library(here)
# load required packages
source(here("setup.R"))

# load all regulations.gov rules as "d"
load(here("data/AllRegsGovRules.Rdata"))
regs.gov <- d
regs.gov %<>% unique()
regs.gov %<>% filter(!is.na(documentType), documentType != "NA")

# format as regs.govate
regs.gov$commentDueDate %<>% as.Date()
regs.gov$postedDate %<>% as.Date()
regs.gov$commentStartDate %<>% as.Date()
regs.gov$openForComment %<>% as.logical()
regs.gov$year <- as.numeric(substr(regs.gov$postedDate, 1, 4))

# to merge 
regs.gov  %<>% mutate(RIN = rin)

# loads as "regs"
load(here("data/OIRAandUA.Rdata"))

d <- full_join(regs.gov, regs)
```


```{r summary-table}
count <- d %>% filter(year > 1993, !is.na(commentStartDate)) %>%  filter(documentType == "Proposed Rule") %>% 
  group_by(documentType, agencyAcronym) %>%
  mutate(mean = round(mean(numberOfCommentsReceived))) %>% 
  mutate(median = median(numberOfCommentsReceived)) %>% 
  mutate(max = max(numberOfCommentsReceived)) %>%
  mutate(z = ifelse(numberOfCommentsReceived==0, T, F)) %>% 
  mutate(zero = sum(numberOfCommentsReceived == 0)) %>%
  mutate(total = n()) %>%
  group_by(z, agencyAcronym, documentType) %>% 
  mutate(medianW.O.zero = median(numberOfCommentsReceived)) %>% 
  ungroup() %>% group_by(documentType, agencyAcronym) %>% mutate(medianW.O.zero = max(medianW.O.zero)) %>% 
   group_by(agencyAcronym, documentType, mean, median, max, zero, medianW.O.zero) %>% tally() %>% arrange(-n)
```


```{r comments-per-year, fig.height = 4}
d %>% filter(year > 2005, !is.na(commentStartDate)) %>% 
  filter(documentType == "Proposed Rule") %>%
  group_by(year) %>% 
  mutate(rank = row_number(numberOfCommentsReceived)) %>% 
  ggplot() +
  geom_col(aes(y = numberOfCommentsReceived, x = rank, color = numberOfCommentsReceived)) +
  geom_point(aes(y = numberOfCommentsReceived, x = rank, color = numberOfCommentsReceived), shape = 18) +
  scale_color_gradient(low="blue", high="red")+
  scale_y_log10(breaks = c(0, 1, 10, 10^2,10^3,10^4,10^5,10^6, 10^7),
                     labels = c("0", "1", "10", "100", "1k", "10k", "100k", "1m","10m") ) + 
  labs(x = "Proposed Rules on Regulations.gov Ranked by Number of Comments",
       y = "Number of Comments (Log scale)", 
       color = "", fill = "") + 
  facet_wrap(~ year, ncol = 6)+
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))
```

```{r type-comment-density, fig.height = 6.5}
# TYPEpoint log log 
count <- d %>% filter(year > 1993, !is.na(commentStartDate)) %>% # filter(documentType == "Proposed Rule")
  group_by(documentType) %>%
  mutate(mean = round(mean(numberOfCommentsReceived))) %>% 
  mutate(median = median(numberOfCommentsReceived)) %>% 
  mutate(zero = sum(numberOfCommentsReceived == 0)) %>%
  mutate(total = n()) %>%
   group_by(numberOfCommentsReceived, documentType, mean, median, zero, total) %>% tally() %>% arrange(numberOfCommentsReceived) %>% 
  filter(numberOfCommentsReceived > 0) %>%
  ggplot() +
  geom_point(aes(x = numberOfCommentsReceived, 
    y = n,
    color = documentType, fill = documentType),
    alpha = .2) +
  geom_vline(aes(xintercept = mean, color = documentType), linetype="dashed") +
  geom_label(aes(x = mean, y = zero, label = paste(documentType, "mean =", mean, "comments"), color = documentType), check_overlap = TRUE, vjust = -.1) +
  geom_text(aes(x = mean, y = zero, label = paste0(zero,"/", total, " = ", round(zero/total*100),"%", " have no comments"), color = documentType), check_overlap = TRUE, vjust = 1) +
  scale_x_log10(limits = c(1,10^7),
                breaks = c(0,1, 10, 10^2,10^3,10^4,10^5,10^6, 10^7),
                     labels = c("0", "1", "10", "100", "1k", "10k", "100k", "1m","10m") ) + 
  scale_y_log10(breaks = c(0, 1, 10, 10^2,10^3,10^4,10^5,10^6, 10^7),
                     labels = c("0", "1", "10", "100", "1k", "10k", "100k", "1m","10m") ) + 
  labs(#title = paste("All regulations.gov documents open for public comment 1994-2017"),#, sum(d$documentType == "Proposed Rule"),"proposed rules"),
       x = "Number of Comments", 
       y = "Number of Documents", 
       color = "", fill = "") + 
  theme_minimal() +
  theme(legend.position="none")


  
# TYPE DENSITY LOG LOG 
density <-    d %>% filter(year > 1993, !is.na(commentStartDate)) %>% # filter(documentType == "Proposed Rule") %>% #filter(numberOfCommentsReceived > 0) %>% 
    group_by(documentType) %>%
    mutate(mean = round(mean(numberOfCommentsReceived))) %>% 
    mutate(median = median(numberOfCommentsReceived)) %>% 
    mutate(zero = sum(numberOfCommentsReceived == 0)) %>%
    mutate(total = n()) %>% filter(numberOfCommentsReceived > 0) %>% 
    ggplot() +
    geom_histogram(aes(x = numberOfCommentsReceived, 
      color = documentType, fill = documentType),
      alpha = .2, position = "dodge", binwidth = 1, stat = "bin") +
    geom_vline(aes(xintercept = mean, color = documentType), linetype="dashed") +
#    geom_label(aes(x = mean, y = zero, label = paste(documentType, "mean =", mean, "comments"), color = documentType), check_overlap = TRUE, vjust = -.1) +
#    geom_text(aes(x = mean, y = zero, label = paste0(zero,"/", total, " = ", round(zero/total*100),"%", " have no comments"), color = documentType), check_overlap = TRUE, vjust = 1) +
    # scale_x_log10() +
  scale_x_log10(limits = c(1,10^7),
                breaks = c(0,1, 10, 10^2,10^3,10^4,10^5,10^6, 10^7),
                     labels = c("0", "1", "10", "100", "1k", "10k", "100k", "1m","10m") ) + 
  scale_y_continuous(breaks = c(0, 1, 10, 10^2,10^3,10^4,10^5,10^6, 10^7),
                     labels = c("0", "", "", "", "1k", "10k", "100k", "1m","10m") ) +
  labs(x = "Number of Comments", 
       y = "Density", 
       color = "", fill = "") + 
    theme_minimal() +
  theme(legend.position="none",
        panel.grid.major.x = element_blank(), 
        axis.title.x = element_blank() )#,
        #axis.text.x = element_blank())

grid.arrange(density, count, ncol = 1, heights=c(1, 4))
```
   
   


```{r major-comments-density, fig.height = 6.5}
d$MAJOR %<>% gsub("Yes", "Major Rule", .)
d$MAJOR %<>% gsub("No", "Non-major Rule", .)
d$MAJOR[which(d$MAJOR == "Undetermined")] <- NA

# MAJOR point log log 
count <- d %>% filter(year > 1993, !is.na(commentStartDate), !is.na(MAJOR)) %>% filter(documentType == "Proposed Rule") %>% #filter(numberOfCommentsReceived > 0) %>% 
  group_by(MAJOR) %>%
  mutate(mean = round(mean(numberOfCommentsReceived))) %>% 
  mutate(median = median(numberOfCommentsReceived)) %>% 
  mutate(zero = sum(numberOfCommentsReceived == 0)) %>%
  mutate(total = n()) %>%
  group_by(numberOfCommentsReceived, MAJOR, mean, median, zero, total) %>% tally() %>% arrange(numberOfCommentsReceived) %>%
  #  summarize(unique(zero))
  ggplot() +
  geom_point(aes(
    x = numberOfCommentsReceived, 
    y = n,
    color = MAJOR, fill = MAJOR),
    alpha = .2) +
  geom_vline(aes(xintercept = mean, color = MAJOR), linetype="dashed") +
  geom_label(aes(x = mean, y = zero, label = paste(MAJOR, "mean =", mean, "comments"), color = MAJOR), check_overlap = TRUE, vjust = -.1) +
  geom_text(aes(x = mean, y = zero, label = paste0(zero,"/", total, " = ", round(zero/total*100),"%", " have no comments"), color = MAJOR), check_overlap = TRUE, vjust = 1) +
  scale_x_continuous(trans = "log10",
                     breaks = trans_breaks("log10", function(x) 10^x),
                     labels = trans_format("log10", math_format(10^.x) ) ) + 
  scale_y_continuous(trans = "log10",
                     breaks = trans_breaks("log10", function(x) 10^x),
                     labels = trans_format("log10", math_format(10^.x) ) ) + 
  labs(#title = paste("Regulations.gov Proposed Rules in Unified Agenda open for public comment 1994-2017"),#, sum(d$PRIORITY_CATEGORY == "Proposed Rule"),"proposed rules"),
       x = "Number of Comments", 
       y = "Number of Documents", 
       color = "", fill = "") + 
  theme_minimal() +
  theme(legend.position="none")



# MAJOR DENSITY LOG 
density <-  d %>% filter(year > 1993, !is.na(commentStartDate)) %>%  filter(documentType == "Proposed Rule") %>% #filter(numberOfCommentsReceived > 0) %>% 
  group_by(MAJOR) %>%
  mutate(mean = round(mean(numberOfCommentsReceived))) %>% 
  mutate(median = median(numberOfCommentsReceived)) %>% 
  mutate(zero = sum(numberOfCommentsReceived == 0)) %>%
  mutate(total = n()) %>%
  #  summarize(unique(zero))
  ggplot() +
  geom_density(aes(
    x = numberOfCommentsReceived, 
    #y = ..count..,
    color = MAJOR, fill = MAJOR),
    alpha = .2, position = "identity") +
  geom_vline(aes(xintercept = mean, color = MAJOR), linetype="dashed") +
  #    geom_label(aes(x = mean, y = zero, label = paste(MAJOR, "mean =", mean, "comments"), color = MAJOR), check_overlap = TRUE, vjust = -.1) +
  #    geom_text(aes(x = mean, y = zero, label = paste0(zero,"/", total, " = ", round(zero/total*100),"%", " have no comments"), color = MAJOR), check_overlap = TRUE, vjust = 1) +
  scale_x_continuous(trans = "log10",
                     breaks = trans_breaks("log10", function(x) 10^x),
                     labels = trans_format("log10", math_format(10^.x) ) ) + 
  #    scale_y_continuous(trans = "log10",
  #                       breaks = trans_breaks("log10", function(x) 10^x),
  #                       labels = trans_format("log10", math_format(10^.x) ) ) + 
  labs(#title = paste("All regulations.gov documents accepting public comments, 1994-2017"),#, sum(d$MAJOR == "Proposed Rule"),"proposed rules"),
    x = "Number of Comments", 
    y = "Density", 
    color = "", fill = "") + 
  theme_minimal() +
  theme(legend.position="none", 
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        panel.grid = element_blank() )

grid.arrange(density, count, ncol = 1, heights=c(1, 4))
```











   

   
   
  
```{r priority-comment-density, fig.height = 6.5}
# PRIORITY_CATEGORY point log log 
count <- d %>% filter(year > 1993, !is.na(commentStartDate), !is.na(PRIORITY_CATEGORY), PRIORITY_CATEGORY != "Info./Admin./Other") %>% 
  filter(documentType == "Proposed Rule") %>% #filter(numberOfCommentsReceived > 0) %>% 
  group_by(PRIORITY_CATEGORY) %>%
  mutate(mean = round(mean(numberOfCommentsReceived))) %>% 
  mutate(median = median(numberOfCommentsReceived)) %>% 
  mutate(zero = sum(numberOfCommentsReceived == 0)) %>%
  mutate(total = n()) %>%
  group_by(numberOfCommentsReceived, PRIORITY_CATEGORY, mean, median, zero, total) %>% tally() %>% arrange(numberOfCommentsReceived) %>%
  #  summarize(unique(zero))
  ggplot() +
  geom_point(aes(
    x = numberOfCommentsReceived, 
    y = n,
    color = PRIORITY_CATEGORY, fill = PRIORITY_CATEGORY),
    alpha = .2) +
  geom_vline(aes(xintercept = mean, color = PRIORITY_CATEGORY), linetype="dashed") +
  geom_label(aes(x = mean, y = zero, label = paste0(PRIORITY_CATEGORY, ": mean = ", mean, " comments"), color = PRIORITY_CATEGORY), check_overlap = TRUE, vjust = -.1) +
  geom_text(aes(x = mean, y = zero, label = paste0(zero,"/", total, " = ", round(zero/total*100),"%", " have no comments"), color = PRIORITY_CATEGORY), check_overlap = TRUE, vjust = 1) +
  scale_x_continuous(trans = "log10",
                     breaks = trans_breaks("log10", function(x) 10^x),
                     labels = trans_format("log10", math_format(10^.x) ) ) + 
  scale_y_continuous(trans = "log10",
                     breaks = trans_breaks("log10", function(x) 10^x),
                     labels = trans_format("log10", math_format(10^.x) ) ) + 
  labs(#title = paste("Regulations.gov Proposed Rules in Unified Agenda open for public comment 1994-2017"),#, sum(d$PRIORITY_CATEGORY == "Proposed Rule"),"proposed rules"),
       x = "Number of Comments", 
       y = "Number of Documents", 
       color = "", fill = "") + 
  theme_minimal() +
  theme(legend.position="none")



# PRIORITY_CATEGORY DENSITY LOG 
density <-  d %>% filter(year > 1993, !is.na(commentStartDate), !is.na(PRIORITY_CATEGORY), PRIORITY_CATEGORY != "Info./Admin./Other") %>%
  filter(documentType == "Proposed Rule") %>% #filter(numberOfCommentsReceived > 0) %>% 
  group_by(PRIORITY_CATEGORY) %>%
  mutate(mean = round(mean(numberOfCommentsReceived))) %>% 
  mutate(median = median(numberOfCommentsReceived)) %>% 
  mutate(zero = sum(numberOfCommentsReceived == 0)) %>%
  mutate(total = n()) %>%
  #  summarize(unique(zero))
  ggplot() +
  geom_density(aes(
    x = numberOfCommentsReceived, 
    #y = ..count..,
    color = PRIORITY_CATEGORY, fill = PRIORITY_CATEGORY),
    alpha = .2, position = "identity") +
  geom_vline(aes(xintercept = mean, color = PRIORITY_CATEGORY), linetype="dashed") +
  #    geom_label(aes(x = mean, y = zero, label = paste(PRIORITY_CATEGORY, "mean =", mean, "comments"), color = PRIORITY_CATEGORY), check_overlap = TRUE, vjust = -.1) +
  #    geom_text(aes(x = mean, y = zero, label = paste0(zero,"/", total, " = ", round(zero/total*100),"%", " have no comments"), color = PRIORITY_CATEGORY), check_overlap = TRUE, vjust = 1) +
  scale_x_continuous(trans = "log10",
                     breaks = trans_breaks("log10", function(x) 10^x),
                     labels = trans_format("log10", math_format(10^.x) ) ) + 
  #    scale_y_continuous(trans = "log10",
  #                       breaks = trans_breaks("log10", function(x) 10^x),
  #                       labels = trans_format("log10", math_format(10^.x) ) ) + 
  labs(#title = paste("All regulations.gov documents accepting public comments, 1994-2017"),#, sum(d$PRIORITY_CATEGORY == "Proposed Rule"),"proposed rules"),
    x = "Number of Comments", 
    y = "Density", 
    color = "", fill = "") + 
  theme_minimal() +
  theme(legend.position="none", 
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        panel.grid = element_blank() )

grid.arrange(density, count, ncol = 1, heights=c(1, 4))
  
```






```{r commets-data}


# format
d$numberOfCommentsReceived %<>% as.numeric()
d$postedDate %<>% as.Date()
d$commentStartDate %<>% as.Date()

# docket vars 
d %<>% group_by(docketId) %>% 
  mutate(numberOfCommentsUnique = n()) %>% 
  mutate(numberOfCommentsTotal = sum(numberOfCommentsReceived)) %>% 
  # FIXME need to merge in comment data 
  # mutate(position.support = grepl(" support ", commentText) ) %>% 
  # mutate(position.oppose = grepl(" oppose ", commentText) ) %>% 
  # mutate(position.complex = grepl(" support ", commentText) & grepl(" oppose ", commentText) ) %>% 
  ungroup() %>% arrange(desc(numberOfCommentsReceived))

# select(d, organization, numberOfCommentsReceived, numberOfCommentsUnique, numberOfCommentsTotal, agencyAcronym, title)

```

Comments with the word "support": 
`r head(d$commentText[which(grepl(" support ", d$commentText))])`

Comments with the word "oppose": 
`r head(d$commentText[which(grepl(" oppose ", d$commentText))])`

Comments with the both "support" and "oppose": 
`r head(d$position.complex)`

Mass comments:
`head(d$commentText)`





# To do:

- Shiny app to make datasets with search terms via regulations.gov API


            