---
title: "The Environmental Justice Movement's Impact in Agency Rulemaking"
subtitle: "Technical Appendix and Replication Code" 
author: "Devin Judge-Lord"
output:
    # pdf_document:
    #   toc: true
    #   keep_tex: true
    html_document:
      highlight: zenburn
      toc: true
      toc_float: true
      code_folding: hide
editor_options: 
  chunk_output_type: console
---


```{r global.options, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      cache = FALSE, 
                      fig.width=8.5, 
                      split = T,
                      fig.align = 'center', 
                      fig.path='figs/',
                      warning=FALSE, 
                      message=FALSE)


library(tidyverse)
library(broom)
library(magrittr)
library(tidytext)
library(knitr)
library(kableExtra)

library(ggplot2); theme_set(theme_bw())
  options(
    ggplot2.continuous.color = "viridis",
    ggplot2.continuous.fill = "viridis"
  )
  scale_color_discrete <- function(...)
    scale_color_viridis_d(..., direction = -1)
  scale_fill_discrete <- function(...)
    scale_fill_viridis_d(..., direction = -1)
  
  
kablebox <- . %>% 
  head(100) %>% 
  knitr::kable(digits = 3) %>% 
  kable_styling() %>% 
  scroll_box(height = "400px")
```

Replication data are available in SQL and Rdata at https://github.com/judgelord/rulemaking 

```{r}
library(DBI)
library(RSQLite)
#library(sqldf)

con <- DBI::dbConnect(RSQLite::SQLite(), here::here("db", "regs_dot_gov.sqlite"))
```



```{sql, connection=con, output.var = "rules", eval = FALSE}
SELECT * FROM rules WHERE document_type = 'Proposed Rule'
```


```{r ej-rules, fig.height=11}
load(here::here("data", "ejPR.Rdata"))
load(here::here("data", "ejFR.Rdata"))
load(here::here("data", "ejcomments.Rdata"))
load(here::here("data", "regs_dot_gov_actions.Rdata"))

namingthings <- function(x){
  names(x)  <- names(x) %>% 
    str_replace_all("([A-Z])", "_\\1") %>% 
    str_to_lower()
  
  x$allow_late_comment %<>% as.logical()
  x$attachment_count %<>% as.integer()
  x$number_of_comments_received %<>% as.integer()
  x$open_for_comment %<>% as.logical()
  x$posted_date %<>% as.Date()

  return(x)
}

ejFR %<>% namingthings()
ejPR %<>% namingthings()
ejcomments %<>% namingthings()

# add vars for ej_comments + unique ej comments
ejcomments %<>% 
  group_by(docket_id) %>% 
  mutate(ej_comments = sum(number_of_comments_received),
         ej_comments_unique = n() ) 


regs_dot_gov_actions %<>% 
  namingthings() %>% 
  # add ej comments and ej unique comment counts
  left_join(ejcomments %>% 
              select(docket_id, ej_comments, ej_comments_unique) %>% 
              distinct()) %>%
  # drop rules before clinton
  filter(!is.na(posted_date),
         posted_date > as.Date("1993-01-20") ) %>% 
         # indicators for ej in various docs
  mutate(ej_pr = docket_id %in% ejPR$docket_id,
         ej_comment = docket_id %in% ejcomments$docket_id,
         ej_fr = docket_id %in% ejFR$docket_id,
         # indicator for president
         president = ifelse(posted_date < as.Date("2017-01-17"), "Obama", "Trump"),
         president = ifelse(posted_date < as.Date("2009-01-20"), "G. W. Bush", president),
         president = ifelse(posted_date < as.Date("2001-01-20"), "Clinton", president),
         year = str_sub(posted_date, 3,4),
         year = str_c("`", year),
         comments = number_of_comments_received,
         agency = agency_acronym
         ) 



# share of ej rules
regs_dot_gov_actions %>% 
  ggplot() + 
  aes(y = agency, fill = ej_fr) +
  geom_bar()
  
# filter to agencies that published at least one ej rule 
regs_dot_gov_actions %<>% 
  group_by(agency) %>% 
  mutate(agency_ej_rules = sum(ej_fr),
         agency_ej_comments = sum(ej_comment),
         agency_ej_nprms = sum(ej_pr)) %>%
  ungroup() %>% 
  filter(agency_ej_rules > 0 | agency_ej_nprms > 0)

# agencies that published at least one ej rule
regs_dot_gov_actions %>% 
   ggplot() + 
  aes(y = agency, fill = ej_fr) +
  geom_bar()

# agencies that published at least 100 rules with ej comments
regs_dot_gov_actions %>% 
  filter(agency_ej_comments > 100) %>% 
   ggplot() + 
  aes(y = agency, fill = ej_fr) +
  geom_bar()


# All proposed rules
allPR <- regs_dot_gov_actions %>% 
  # subset to final rules
  filter(document_type == "Proposed Rule")

# All final rules
allFR <- regs_dot_gov_actions %>% 
  # subset to final rules with an NPRM 
  filter(document_type == "Rule") %>%
  # direct to final rules
  mutate(direct = ifelse(docket_id %in% allPR$docket_id, "Draft Rule Published", "Direct to Final Rule"))
```

# Draft Rules 

```{r ej_pr}
allPR %>% 
  count(year, ej_pr, president) %>%
  ggplot() + 
  aes(x = year, y = n, fill = ej_pr) + 
  geom_col() + 
  facet_grid(. ~ president, scales = "free") + 
  labs(x = "Year",
       y = "Number of Proposed Rules",
       fill = "Environmental\nJustice\nAnalysis") + 
  theme(panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle = 270))
```


# Final Rules

```{r ej_fr}
allFR %>% 
  count(year, ej_fr, direct, president) %>%
  ggplot() + 
  aes(x = year, y = n, fill = ej_fr) + 
  geom_col() + 
  facet_grid(direct ~ president, scales = "free") + 
  labs(x = "Year",
       y = "Number of Final Rules",
       fill = "Environmental\nJustice\nAnalysis") + 
  theme(panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle = 270))
```

---

# Comments 

```{r ej_comments}
allFR %>% 
  filter(direct == "Draft Rule Published") %>% 
  mutate(ej_pr = ifelse(ej_pr, "EJ in Draft Rule", "EJ not in Draft Rule")) %>% 
  ggplot() + 
  aes(x = posted_date, y = comments, color = ej_comment) + 
  geom_point(alpha = .5) + 
  facet_grid(ej_pr ~ president, scales = "free_x") + 
  scale_y_log10()  +
  scale_x_date(date_labels = "%y") + 
  labs(x = "",
       y = "Number of Comments (log scale)",
       color = "Environmental\nJustice\nConcerns") + 
  theme(panel.grid.major.x = element_blank())
```

---

# Proposed rules that did not address EJ
```{r}
# Final Rules that where ej was not mentioned in the NPRM
ejFR_PR <- allFR %>% 
  filter(docket_id %in% allPR$docket_id,
         !ej_pr)
```

## By president

```{r ej-m-PR-president}
m_PR_president <- glm(ej_fr ~ ej_comment + 
              comments + 
              president,
           data = ejFR_PR, 
             family=binomial(link="logit"))

tidy(m_PR_president) %>% kablebox()

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  expand(ej_comment,
         comments = #c(min(comments),
                      mean(comments) %>% round(),
                      #max(comments)),
         president)

predicted <- augment(m_PR_president,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     ) 


# As a plot
predicted %>% 
  ggplot() + 
  aes(x = ej_comment, y = .fitted, color = ej_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("president", ncol = 1) +
  labs(y = 'Probability that "environmental justice" is added', 
       x = "",
       color =  '"environmental justice"\nraised by comments',
       title = "Predicted change in Final Rules") + 
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

---

## By Agency 

```{r ej-m-PR-agency}
m_PR_agency <- glm(ej_fr ~ ej_comment + 
              comments + 
              agency,
           data = ejFR_PR, 
             family=binomial(link="logit"))

tidy(m_PR_agency) %>% kablebox()

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>%
  expand(ej_comment,
         comments = #c(min(comments),
                      mean(comments) %>% round(),
                      #max(comments)),
         agency)

predicted <- augment(m_PR_agency,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     ) 

# calculate difference in probabilities
predicted %<>% 
  group_by(agency) %>% 
  mutate(diff = abs(sum(.fitted) - .fitted - .fitted)*100) %>% 
  mutate(diff = round(diff, 0) %>% str_pad(2, side = "left", pad = "0")) %>% 
  mutate(Agency = str_c(diff, "% increase at ", agency)) %>% arrange(Agency)


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  ggplot() + 
  aes(x = Agency, y = .fitted, color = ej_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .5)  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  #facet_wrap("agency", ncol = 1, scales = "free") +
  labs(y = 'Probability that "environmental justice" is added', 
       x = "",
       color =  '"environmental justice"\nraised by comments',
       title = "Predicted change in Final Rules") + 
  theme(#axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

### Agencies that have over 100 comments on proposed rules that did not mention environmental justice (i.e. agencies where at least some of the rules in this dataset saw more than a few comments) and 100 rules where comments raised EJ concerns (i.e. agencies where EJ is somewhat salient). 

```{r ej-m-PR-agency-top}
top <- ejFR_PR %>% 
  group_by(agency) %>% 
  filter(sum(comments) > 100,
         agency_ej_comments > 100) %>% 
    ungroup() %>% 
    .$agency %>% 
    unique()


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  filter(agency %in% top) %>% 
  ggplot() + 
  aes(x = Agency, y = .fitted, color = ej_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .5)  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  labs(y = 'Probability that "environmental justice" is added', 
       x = "",
       color =  '"environmental justice"\nraised by comments',
       title = "Predicted change in Final Rules") + 
  theme(panel.grid.major.y = element_blank(),
        axis.ticks.y = element_blank())
```


# Proposed rules that did address EJ