---
title: "The Environmental Justice Movement's Impact in Agency Rulemaking"
subtitle: "Technical Appendix and Replication Code" 
author: "Devin Judge-Lord"
output:
    # pdf_document:
    #   toc: true
    #   keep_tex: true
    html_document:
      highlight: zenburn
      toc: true
      toc_float: true
      code_folding: hide
editor_options: 
  chunk_output_type: console
---


```{r global.options, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      cache = FALSE, 
                      fig.width=8.5, 
                      split = T,
                      fig.align = 'center', 
                      fig.path='figs/',
                      warning=FALSE, 
                      message=FALSE)


library(tidyverse)
library(broom)
library(magrittr)
library(tidytext)
library(knitr)
library(kableExtra)

library(ggplot2); theme_set(theme_bw())
  options(
    ggplot2.continuous.color = "viridis",
    ggplot2.continuous.fill = "viridis"
  )
  scale_color_discrete <- function(...)
    scale_color_viridis_d(..., direction = -1)
  scale_fill_discrete <- function(...)
    scale_fill_viridis_d(..., direction = -1)
  
  
kablebox <- . %>% 
  head(100) %>% 
  knitr::kable(digits = 3) %>% 
  kable_styling() %>% 
  scroll_box(height = "400px")
```

# Data

Replication data are available in SQL and Rdata at https://github.com/judgelord/rulemaking 

```{r}
library(DBI)
library(RSQLite)
#library(sqldf)

con <- DBI::dbConnect(RSQLite::SQLite(), here::here("db", "regs_dot_gov.sqlite"))
```



```{sql, connection=con, output.var = "regs_dot_gov_actions ", eval = FALSE}
SELECT * FROM rules
```


```{r data, fig.height=11, cache=TRUE}
load(here::here("data", "ejPRnew.Rdata"))
ejPR <- ejPRnew #FIXME 
load(here::here("data", "ejFRnew.Rdata"))
ejFR <- ejFRnew
load(here::here("data", "ejcommentsnew.Rdata"))
ejcomments <- ejcommentsnew
load(here::here("data", "rules_metadata.Rdata"))
# alternatively 
#rules <- dbGetQuery(con, "SELECT * FROM rules")

# unique
ejPR %<>% 
  select(-page, #FIXME,
         -open_for_comment,
         -type, -document_type, -withdrawn, -links) %>% 
  distinct()

ejFR %<>% 
  select(-page, #FIXME
         -open_for_comment,
         -type, -document_type, -withdrawn, -links) %>% 
  distinct()

ejcomments %<>% 
  select(-lastpage, -type, -document_type, -withdrawn, -links) %>% 
  distinct() 

# summary vars
ejcomments %<>%
  mutate(docket_id = str_remove(id, "-[0-9]*$") ) 

rules %<>% filter(document_type %in% c("Proposed Rule", "Rule"),
                    # drop rules before clinton
                  !is.na(posted_date),
                  posted_date > as.Date("1993-01-20"),
                  # rulemaking dockets only
                  docket_type == "Rulemaking" ) 


# make summary vars in main data
rules %<>% 
  # # add ej comments and ej unique comment counts #FIXME merge in counts from old data, find if new API has this
  # left_join(ejcomments %>% 
  #             group_by(docket_id) %>% 
  #             summarise(ej_comments = sum(number_of_comments_received) ) ) %>%
  left_join(ejcomments %>% 
              count(docket_id, name = "ej_comments_unique") ) %>% 
  mutate(#ej_comments = replace_na(ej_comments, 0),
         ej_comments_unique = replace_na(ej_comments_unique, 0)) 

# indicators for ej in various docket-level variables
rules %<>% 
  group_by(docket_id) %>% 
  mutate(comments = sum(number_of_comments_received)) %>% 
  ungroup() %>% 
  mutate(ej_pr = docket_id %in% ejPR$docket_id,
         ej_comment = docket_id %in% ejcomments$docket_id,
         ej_fr = docket_id %in% ejFR$docket_id,
         # indicator for president
         president = ifelse(posted_date < as.Date("2017-01-17"), "Obama", "Trump"),
         president = ifelse(posted_date < as.Date("2009-01-20"), "G. W. Bush", president),
         president = ifelse(posted_date < as.Date("2001-01-20"), "Clinton", president),
         year = str_sub(posted_date, 1,4),
         Year = str_sub(posted_date, 3,4),
         Year = str_c("`", Year),
         agency = agency_id
         ) 

rules %<>% select(docket_id, 
                 docket_title, 
                 #ej_comments, 
                 ej_comments_unique, 
                 ej_pr, 
                 ej_comment, 
                 ej_fr, 
                 president, year, 
                 comments, 
                 agency, 
                 document_type,
                 year,
                 Year) %>%
  distinct()

# document type over time
rules %>% 
  ggplot() + 
  aes(x = year, fill = document_type) +
  geom_bar()

# document type over time
rules %>% 
  ggplot() + 
  aes(x = year, fill = ej_fr) +
  geom_bar()



# filter to agencies that published at least one ej rule 
rules %<>% 
  group_by(agency) %>% 
  mutate(agency_ej_rules = sum(ej_fr),
         agency_ej_comments = sum(ej_comments_unique),
         agency_ej_nprms = sum(ej_pr)) %>%
  ungroup() %>% 
  filter(agency_ej_rules > 0 | agency_ej_nprms > 0)

rules %>% 
  ggplot() + 
  aes(x = year, fill = ej_fr) +
  facet_wrap("agency", scales = "free") +
  geom_bar()


# agencies that published at least 100 rules with ej comments
rules %>% 
  filter(agency_ej_comments > 100 | agency == "FEMA") %>% 
  ggplot() + 
  aes(x = year, fill = ej_fr) +
  facet_wrap("agency", scales = "free") +
  geom_bar()


# All proposed rules
allPR <- rules %>% 
  # subset to final rules
  filter(document_type == "Proposed Rule")


# All final rules
allFR <- rules %>% 
  # subset to final rules with an NPRM 
  filter(document_type == "Rule") %>%
  # direct to final rules
  mutate(direct = ifelse(docket_id %in% allPR$docket_id, "Draft Rule Published", "Direct to Final Rule"))
```

# Draft Rules 

```{r ej_pr}
allPR %>% 
  count(year, ej_pr, president) %>%
  ggplot() + 
  aes(x = year, y = n, fill = ej_pr) + 
  geom_col() + 
  facet_grid(. ~ president, scales = "free") + 
  labs(x = "Year",
       y = "Number of Proposed Rules",
       fill = "Environmental\nJustice\nAnalysis") + 
  theme(panel.grid.major.x = element_blank())
        #axis.text.x = element_text(angle = 270))
```


# Final Rules

```{r ej_fr}
allFR %>% 
  count(year, ej_fr, direct, president) %>%
  ggplot() + 
  aes(x = year, y = n, fill = ej_fr) + 
  geom_col() + 
  facet_grid(direct ~ president, scales = "free") + 
  labs(x = "Year",
       y = "Number of Final Rules",
       fill = "Environmental\nJustice\nAnalysis") + 
  theme(panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle = 270))
```

---

# Comments 

```{r ej_comments}
allFR %>% 
  filter(direct == "Draft Rule Published") %>% 
  mutate(ej_pr = ifelse(ej_pr, "EJ in Draft Rule", "EJ not in Draft Rule")) %>% 
  ggplot() + 
  aes(x = Year, y = comments, color = ej_comment) + 
  geom_point(alpha = .5) + 
  facet_grid(ej_pr ~ president, scales = "free_x") + 
  scale_y_log10()  +
  #scale_x_date(date_labels = "%y") + 
  labs(x = "",
       y = "Number of Comments (log scale)",
       color = "Environmental\nJustice\nConcerns") + 
  theme(panel.grid.major.x = element_blank())
```

---

# Proposed rules that did not address EJ
```{r}
# Final Rules that where ej was not mentioned in the NPRM
ejFR_PR <- allFR %>% 
  filter(docket_id %in% allPR$docket_id,
         !ej_pr)
```

```{r ej-PR-winrate}
winrate <- ejFR_PR %>% 
  count(ej_comment, ej_fr) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(ej_fr, n) %>% 
  mutate(percent = round(`TRUE`/`FALSE`*100 ))

winrate

ejFR_PR %>% 
  count(ej_comment, ej_fr) %>% 
  left_join(winrate) %>%
  group_by(ej_comment) %>% 
  mutate(mean = mean(c(`TRUE`, `FALSE`)),
        EJ_comment = ifelse(ej_comment, "EJ Raised by Commenters", "EJ not Raised by Commenters")) %>% 
  ggplot() + 
  aes(x = EJ_comment, 
      y = n, 
      fill = ej_fr, 
      label = ifelse(ej_fr == ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col() + 
  geom_text(aes(y = mean)) + 
  facet_wrap("EJ_comment", scales = "free") + 
  labs(fill = "EJ in Final Rule") + 
  theme_void() +
  theme(axis.text.y = element_text(),
        panel.grid.major.y = element_line(color = "grey"))
```

## By president
```{r ej-PR-winrate-president}
winrate <- ejFR_PR %>% 
  count(ej_comment, ej_fr, president) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(ej_fr, n) %>% 
    mutate(`FALSE` = replace_na(`FALSE`, 0)) %>%
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 ))

winrate

ejFR_PR %>% 
  count(ej_comment, ej_fr, president) %>% 
  left_join(winrate) %>%
  group_by(ej_fr) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "EJ Comments", "No EJ Comments")) %>% 
  ggplot() + 
  aes(x = EJ_comment, y = n, 
      fill = ej_fr, 
      label = ifelse(ej_fr== ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col() + 
  geom_text(aes(y = `TRUE`*2)) + 
  facet_wrap("president", scales = "free")+ 
  labs(fill = "EJ in Final Rule") + 
  #theme_void() +
  theme(axis.ticks = element_blank(),
        panel.grid.major.x = element_blank())
```

```{r ej-m-PR-president}
m_PR_president <- glm(ej_fr ~ ej_comment + 
              comments +
                #ej_comments + 
                ej_comments_unique +
              president,
           data = ejFR_PR, 
             family=binomial(link="logit"))

tidy(m_PR_president) %>% kablebox()

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>% 
  expand(ej_comment,
         #ej_comments = mean(ej_comments) %>% round(),
         ej_comments_unique = mean(ej_comments_unique) %>% round(),
         comments = #c(min(comments),
                      mean(comments) %>% round(),
                      #max(comments)),
         president)

predicted <- augment(m_PR_president,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     ) 


# As a plot
predicted %>% 
  ggplot() + 
  aes(x = ej_comment, y = .fitted, color = ej_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                  ymax = .fitted + 1.96*.se.fit) )  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  facet_wrap("president", ncol = 1) +
  labs(y = 'Probability that "environmental justice" is added', 
       x = "",
       color =  '"environmental justice"\nraised by comments',
       title = "Predicted change in Final Rules") + 
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

---

## By Agency 

```{r ej-PR-winrate-agency}
winrate <- ejFR_PR %>% 
  count(ej_comment, ej_fr, agency) %>% 
  group_by(ej_comment) %>% #FIXME make nice table with percents
  spread(ej_fr, n) %>% 
    mutate(`FALSE` = replace_na(`FALSE`, 0)) %>%
  mutate(`TRUE` = replace_na(`TRUE`, 0)) %>%
  mutate(percent = round(`TRUE`/(`TRUE`+`FALSE`)*100 ))

winrate

# winrate 
ejFR_PR %>% count(agency, ej_comment, ej_fr)  %>% 
  add_count(agency) %>% 
  filter(nn == 4) %>% 
  left_join(winrate) %>%
  group_by(ej_fr) %>% 
  mutate(EJ_comment = ifelse(ej_comment, "EJ Comments", "No EJ Comments") ) %>% 
  ggplot() + 
  aes(x = EJ_comment, y = n, 
      fill = ej_fr, 
      label = ifelse(ej_fr== ej_comment, percent, NA) %>% str_c("%") ) +
  geom_col() + 
  geom_text(aes(y = `TRUE`), vjust = 0) + 
  facet_wrap("agency", scales = "free")+ 
  labs(fill = "EJ in Final Rule") + 
  #theme_void() +
  theme(axis.ticks = element_blank(),
        panel.grid.major.x = element_blank())
```

```{r ej-m-PR-agency}
m_PR_agency <- glm(ej_fr ~ ej_comment + 
              comments + 
              agency,
           data = ejFR_PR, 
             family=binomial(link="logit"))

tidy(m_PR_agency) %>% kablebox()

# A data frame of values at which to estimate probabilities:
values <- ejFR_PR %>%
  expand(ej_comment,
         comments = #c(min(comments),
                      mean(comments) %>% round(),
                      #max(comments)),
         agency)

predicted <- augment(m_PR_agency,  
                     type.predict = "response",
                     newdata = values,
                     se_fit = TRUE
                     ) 

# calculate difference in probabilities
predicted %<>% 
  group_by(agency) %>% 
  mutate(diff = abs(sum(.fitted) - .fitted - .fitted)*100) %>% 
  mutate(diff = round(diff, 0) %>% str_pad(2, side = "left", pad = "0")) %>% 
  mutate(Agency = str_c(diff, "% increase at ", agency)) %>% arrange(Agency)


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  ggplot() + 
  aes(x = Agency, y = .fitted, color = ej_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .5)  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  #facet_wrap("agency", ncol = 1, scales = "free") +
  labs(y = 'Probability that "environmental justice" is added', 
       x = "",
       color =  '"environmental justice"\nraised by comments',
       title = "Predicted change in Final Rules") + 
  theme(#axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

Agencies that have at least 300 comments on proposed rules that did not mention environmental justice (i.e. agencies where at least some of the rules in this dataset saw comments) and at least 3 rules where comments raised EJ concerns (i.e. agencies where EJ is somewhat salient). 

```{r ej-m-PR-agency-top10}
ejFR_PR %>% group_by(agency) %>% count(agency, agency_ej_comments,sum(comments) )  %>%   kablebox()


top <- ejFR_PR %>% 
  group_by(agency) %>% 
  filter(sum(comments) >=300,
         agency_ej_comments >=3) %>% 
    ungroup() %>% 
    .$agency %>% 
    unique()


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  filter(agency %in% top) %>% 
  ggplot() + 
  aes(x = Agency, y = .fitted, color = ej_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .5)  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  labs(y = 'Probability that "environmental justice" is added', 
       x = "",
       color =  '"environmental justice"\nraised by comments',
       title = "Predicted change in Final Rules") + 
  theme(panel.grid.major.y = element_blank(),
        axis.ticks.y = element_blank())
```


A more slective subset: Agencies that have at least 500 comments on proposed rules that did not mention environmental justice (i.e. agencies where at least some of the rules in this dataset saw more than a few comments) and at least 50 rules where comments raised EJ concerns (i.e. agencies where EJ is somewhat salient). 

```{r ej-m-PR-agency-top100, fig.height=3}

# slightly more selective, requiring 100 comments
top <- ejFR_PR %>% 
  group_by(agency) %>% 
  filter(sum(comments) >=500,
         agency_ej_comments >=50) %>% 
    ungroup() %>% 
    .$agency %>% 
    unique()


# As a plot
predicted %>% 
  arrange(.fitted) %>%
  filter(agency %in% top) %>% 
  ggplot() + 
  aes(x = Agency, y = .fitted, color = ej_comment) + 
  geom_pointrange(aes(ymin = .fitted - 1.96*.se.fit,
                      ymax = .fitted + 1.96*.se.fit),
                  alpha = .5)  + 
  geom_hline(yintercept = 0, linetype = 2) +
  coord_flip() +
  labs(y = 'Probability that "environmental justice" is added', 
       x = "",
       color =  '"environmental justice"\nraised by comments',
       title = "Predicted change in Final Rules") + 
  theme(panel.grid.major.y = element_blank(),
        axis.ticks.y = element_blank())
```


### Example dockets
```{r}

top_dockets <- ejFR_PR %>%
  filter(agency %in% c(top, "HUD", "FRA", "DHS", "DOJ", "ED", "DOS", "BIA", "USCBP", "OSHA", "RUS" ),
         ej_fr, # ej added 
         ej_comment) %>% # with ej comments  
  select(docket_id, docket_title) %>% distinct() %>% pull(docket_id)

rules %>% filter(docket_id %in% top_dockets) %>% select(docket_id, docket_title, document_type, comments, ej_comments) %>% arrange(docket_id) %>% kablebox()
```

### Example comments

Excerpts from comments mentioning "environmental justice" on proposed rules that did not address environmental justice: 
```{r}
ejcomments %>% 
  filter(docket_id %in% ejFR_PR$docket_id) %>% 
  filter(str_detect(summary, "Environmental Justice")|str_detect(str_to_lower(comment_text), "environmental justice")) %>% 
  mutate(comment_text = comment_text %>%  
           str_extract(regex(".*environmental justice", ignore.case = T) ) ) %>% 
  mutate(summary = coalesce(summary, comment_text) %>% str_sub(1,1000) ) %>% 
  select(docket_id, summary) %>% kablebox()

ejFR %>% 
  filter(docket_id %in% ejFR_PR$docket_id) %>% 
  select(docket_id, docket_title, summary) %>% kablebox()
```

# Proposed rules that did address EJ



# Proposed rules that did not address EJ
```{r}
# Final Rules that where ej was mentioned in the NPRM
ejFR_PR <- allFR %>% 
  filter(docket_id %in% allPR$docket_id,
         ej_pr)
```






